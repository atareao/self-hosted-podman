[Unit]
Description=PocketID Authentication Server
After=traefik.service

[Container]
Image=ghcr.io/pocket-id/pocket-id:v2
ContainerName=pocketid
Network=proxy.network

# Persistencia
Volume=pocketid-data.volume:/app/data:Z

Secret=pocketid_encryption_key

# Configuración básica
Environment=APP_URL=https://auth.{{ env.FQDN }}
Environment=ENCRYPTION_KEY_FILE=/run/secrets/pocketid_encryption_key
Environment=TRUST_PROXY=false
Environment=PUID=1000
Environment=PGID=1000

# Etiquetas para Traefik
Label=traefik.enable=true
Label=traefik.http.routers.pocketid.rule=Host(`auth.{{ env.FQDN }}`)
Label=traefik.http.routers.pocketid.entrypoints=websecure
Label=traefik.http.routers.pocketid.tls.certresolver=myresolver
Label=traefik.http.services.pocketid.loadbalancer.server.port=1411

HealthCmd=/app/pocket-id healthcheck
HealthInterval=1m30s
HealthTimeout=5s
HealthRetries=3
HealthStartPeriod=10s

[Service]
Environment=SOPS_AGE_KEY_FILE=%h/.secrets/sops/age/key.txt
Environment=PATH=/usr/local/bin:/usr/bin:%h/.local/bin
Restart=always

[Install]
WantedBy=default.target
